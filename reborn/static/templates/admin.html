{% extends "base.html" %}

{% block title %}Admin Panel - {{ university.name if university else 'University Marketplace' }}{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-3">
                <span class="text-gradient">
                    <i class="fas fa-cog me-3"></i>Admin Panel
                </span>
            </h1>
            <p class="lead text-muted">Manage sellers and monitor marketplace activity</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-5 g-4">
        <div class="col-md-3">
            <div class="card border-0 text-white h-100" style="background: var(--gradient-primary);">
                <div class="card-body text-center p-4">
                    <i class="fas fa-users display-4 mb-3"></i>
                    <h3 class="fw-bold">{{ sellers|length }}</h3>
                    <p class="card-text">Total Sellers</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 text-white h-100" style="background: var(--gradient-success);">
                <div class="card-body text-center p-4">
                    <i class="fas fa-box display-4 mb-3"></i>
                    <h3 class="fw-bold">{{ products|length }}</h3>
                    <p class="card-text">Total Products</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 text-white h-100" style="background: var(--gradient-warning);">
                <div class="card-body text-center p-4">
                    <i class="fas fa-user-check display-4 mb-3"></i>
                    <h3 class="fw-bold">{{ sellers|selectattr('is_active')|list|length }}</h3>
                    <p class="card-text">Active Sellers</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 text-white h-100" style="background: var(--gradient-secondary);">
                <div class="card-body text-center p-4">
                    <i class="fas fa-shopping-cart display-4 mb-3"></i>
                    <h3 class="fw-bold">{{ purchase_requests|length if purchase_requests else 0 }}</h3>
                    <p class="card-text">Purchase Requests</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="d-flex gap-3 flex-wrap">
                <a href="{{ url_for('add_seller') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-user-plus me-2"></i>Add New Seller
                </a>
                <a href="{{ url_for('university_settings') }}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-university me-2"></i>University Settings
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-lg">
                    <i class="fas fa-store me-2"></i>View Marketplace
                </a>
            </div>
        </div>
    </div>

    <!-- Sellers Management -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-users me-2"></i>Sellers Management
                    </h3>
                </div>
                <div class="card-body">
                    {% if sellers %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Profile</th>
                                        <th>Name</th>
                                        <th>Department</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                        <th>Products</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for seller in sellers %}
                                        <tr class="{% if not seller.is_active %}table-secondary{% endif %}">
                                            <td>
                                                <img src="{{ seller.profile_image_url or ('https://via.placeholder.com/40x40/007bff/ffffff?text=' + seller.name[0].upper()) }}" 
                                                     class="rounded-circle" 
                                                     width="40" height="40" 
                                                     alt="{{ seller.name }}">
                                            </td>
                                            <td>
                                                <strong>{{ seller.name }}</strong>
                                                {% if seller.rating > 0 %}
                                                    <br>
                                                    <small class="text-warning">
                                                        {% for i in range(5) %}
                                                            {% if i < seller.rating %}
                                                                <i class="fas fa-star"></i>
                                                            {% else %}
                                                                <i class="far fa-star"></i>
                                                            {% endif %}
                                                        {% endfor %}
                                                        {{ "%.1f"|format(seller.rating) }}
                                                    </small>
                                                {% endif %}
                                            </td>
                                            <td>{{ seller.department }}</td>
                                            <td>
                                                <a href="mailto:{{ seller.email }}" class="text-decoration-none">
                                                    {{ seller.email }}
                                                </a>
                                            </td>
                                            <td>
                                                <a href="tel:{{ seller.phone }}" class="text-decoration-none">
                                                    {{ seller.phone }}
                                                </a>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">
                                                    {{ seller.products|length }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if seller.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{{ url_for('seller_profile', seller_id=seller.id) }}" 
                                                       class="btn btn-outline-info" title="View Profile">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="{{ url_for('toggle_seller_status', seller_id=seller.id) }}" 
                                                       class="btn {% if seller.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}" 
                                                       title="{% if seller.is_active %}Deactivate{% else %}Activate{% endif %} Seller"
                                                       onclick="return confirm('Are you sure you want to {% if seller.is_active %}deactivate{% else %}activate{% endif %} this seller?')">
                                                        <i class="fas {% if seller.is_active %}fa-user-times{% else %}fa-user-check{% endif %}"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users display-1 text-muted mb-3"></i>
                            <h3 class="text-muted">No sellers registered</h3>
                            <p class="text-muted">Start by adding the first seller to the marketplace.</p>
                            <a href="{{ url_for('add_seller') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Add First Seller
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Products -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-box me-2"></i>Recent Products
                    </h3>
                </div>
                <div class="card-body">
                    {% if products %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Image</th>
                                        <th>Product</th>
                                        <th>Seller</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Date Added</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for product in products %}
                                        <tr>
                                            <td>
                                                <img src="{{ product.image_url or ('https://via.placeholder.com/50x50/6c757d/ffffff?text=' + product.name[0].upper()) }}" 
                                                     class="rounded" 
                                                     width="50" height="50" 
                                                     alt="{{ product.name }}"
                                                     style="object-fit: cover;">
                                            </td>
                                            <td>
                                                <strong>{{ product.name }}</strong>
                                                <br>
                                                <small class="text-muted">{{ product.description[:50] }}{% if product.description|length > 50 %}...{% endif %}</small>
                                            </td>
                                            <td>
                                                <a href="{{ url_for('seller_profile', seller_id=product.seller.id) }}" class="text-decoration-none">
                                                    {{ product.seller.name }}
                                                </a>
                                                <br>
                                                <small class="text-muted">{{ product.seller.department }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ product.category }}</span>
                                            </td>
                                            <td>
                                                <span class="fw-bold text-success">{{ product.price|currency }}</span>
                                            </td>
                                            <td>
                                                <small>{{ product.created_at.strftime('%Y-%m-%d') }}</small>
                                            </td>
                                            <td>
                                                {% if product.is_available %}
                                                    <span class="badge bg-success">Available</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Unavailable</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-box-open display-1 text-muted mb-3"></i>
                            <h3 class="text-muted">No products listed</h3>
                            <p class="text-muted">Products will appear here as sellers add them.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Admin Login Modal Template -->
{% if not admin_logged_in %}
<div class="modal fade" id="adminLoginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Admin Login</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin_login') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
