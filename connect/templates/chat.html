{% extends "base.html" %}

{% block title %}Chat with {{ other_user.full_name }} - University of Ibadan Social Platform{% endblock %}

{% block content %}
<div class="container-fluid chat-container">
    <div class="row h-100">
        <div class="col-12">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <a href="{{ url_for('messages') }}" class="btn btn-outline-secondary btn-sm me-3">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        {% if other_user.profile_photo %}
                            <img src="{{ url_for('uploaded_file', filename=other_user.profile_photo) }}" 
                                 alt="{{ other_user.full_name }}" class="chat-avatar">
                        {% else %}
                            <div class="chat-avatar-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                        <div class="ms-3">
                            <h5 class="mb-0">{{ other_user.full_name }}</h5>
                            <small class="text-muted">@{{ other_user.username }} â€¢ {{ other_user.department }}</small>
                        </div>
                    </div>
                    <div class="chat-actions">
                        <a href="{{ url_for('profile', username=other_user.username) }}" 
                           class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-user me-1"></i>Profile
                        </a>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                {% for message in messages %}
                    <div class="message {% if message.sender_id == user.id %}sent{% else %}received{% endif %}">
                        <div class="message-content">
                            <p class="mb-1">{{ message.content }}</p>
                            <small class="message-time text-muted">
                                {{ message.created_at[:19].replace('T', ' ') }}
                            </small>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Chat Input -->
            <div class="chat-input">
                <form id="messageForm" class="d-flex align-items-center">
                    <input type="text" class="form-control me-2" id="messageInput" 
                           placeholder="Type a message..." maxlength="500" required>
                    <button type="submit" class="btn btn-ui-blue">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize Socket.IO
const socket = io();
const currentUserId = '{{ user.id }}';
const otherUserId = '{{ other_user.id }}';
const conversationId = '{{ conversation.id }}';

// Join user room for real-time messaging
socket.emit('join_conversation', {conversation_id: conversationId});

// Message form handling
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    // Send message via Socket.IO
    socket.emit('send_message', {
        receiver_id: otherUserId,
        content: content
    });
    
    // Clear input
    messageInput.value = '';
});

// Handle received messages
socket.on('message_received', function(data) {
    if (data.sender_id === otherUserId) {
        addMessageToChat(data, false);
    }
});

// Handle sent messages
socket.on('message_sent', function(data) {
    addMessageToChat(data, true);
});

// Add message to chat UI
function addMessageToChat(message, isSent) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    
    const timestamp = new Date(message.created_at).toLocaleString();
    
    messageDiv.innerHTML = `
        <div class="message-content">
            <p class="mb-1">${escapeHtml(message.content)}</p>
            <small class="message-time text-muted">${timestamp}</small>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Scroll to bottom of chat
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Auto-resize message input
const messageInput = document.getElementById('messageInput');
messageInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
    }
});

// Initial scroll to bottom
document.addEventListener('DOMContentLoaded', function() {
    scrollToBottom();
});

// Handle connection status
socket.on('connect', function() {
    console.log('Connected to chat server');
});

socket.on('disconnect', function() {
    console.log('Disconnected from chat server');
});
</script>
{% endblock %}